<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        padding: 0px;
        margin: 0px;
        box-sizing: border-box;
        font-family: Poppins, Sans-serif;
        color: white;
      }

      body {
        height: 100vh;
        width: 100vw;
        background-color: #3e6aa2;
      }
      .hidden {
        display: none;
      }
      input:focus {
        outline: none;
      }
      input,
      select {
        color: black;
      }
      .btn-container {
        width: 50%; 
        display: flex; 
        margin-top: 40px
      }

      .heading {
        font-size: 40px; 
        font-weight: 600
      }
      label{
        font-size: 16px;
      }

      .bg-green {
        background-color: green;
        border: 1px solid white;
        color: white;
      }
      .bg-white {
        background-color: white;
        border: 1px solid white;
        color: black;
      }
      .suggestion-dropdown{
          width: 100%;
          height: 200px;
          overflow: auto;
          border: 1px solid #bfbfbf;
          background-color: white;
          border-radius: 10px;
          position: absolute;
          left: 0px;
          top: 86px;
      }
      .suggestion-dropdown div{
        padding: 12px;
        width: 100%;
        color: black;
        border-bottom: 1px solid #bfbfbf;
        font-size: 14px;
        cursor: pointer;
      }
      .error {
        color: red;
        font-size: 14px;
      }
      @media only screen and (max-width: 600px) {
        .heading {
          font-size: 25px;
          text-align: center;
        }
        .btn-container {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div
      style="
        width: 100vw;
        /* height: 100vh; */
        display: flex;
        justify-content: center;
        overflow: auto;
        padding-top: 40px;
      "
    >
      <div style="max-width: 700px; margin-bottom: 300px; padding: 0px 20px">
        <div>
          <!-- <h1 class="heading">
            Singapore New Landed Homes
          </h1> -->
        </div>
        <div style="margin: 20px 0px">
          <p style="font-size: 25px; font-weight: 600">
            Property Valuation Search
          </p>
        </div>
        <div>
          <p style="font-size: 18px">
            Enter your address or search with keywords, and get nearby selling prices updated live from URA. Your detailed home report will be sent within 24 hours via WhatsApp.
          </p>
        </div>

        <div style="display: flex; margin-top: 20px; align-items: center">
          <div
            class="step-one-circle bg-white"
            style="
              border-radius: 50%;
              width: 25px;
              aspect-ratio: 1;
              display: flex;
              justify-content: center;
              align-items: center;
            "
          >
            1
          </div>
          <div style="width: 100%; margin: 0px 10px">
            <hr style="border-top: 0px; color: white" />
          </div>
          <div
            class="step-two-circle"
            style="
              border-radius: 50%;
              border: 1px solid white;
              color: white;
              background-color: #046bd2;
              width: 25px;
              aspect-ratio: 1;
              display: flex;
              justify-content: center;
              align-items: center;
            "
          >
            2
          </div>
        </div>

        <!-- PART ONE -->
        <div class="part-one">
          <div style="margin-top: 40px">
            <div style="width: 100%; height: 55px; position: relative;">
              <label for="postal-code">Address</label>
              <input
                required
                id="postal-code"
                class="postal-code"
                type="text"
                style="
                  font-size: 16px;
                  width: 100%;
                  height: 100%;
                  margin-top: 5px;
                  border-radius: 5px;
                  border: none;
                  padding: 2px 15px;
                  background-color: #d9e2ed;
                "
                placeholder="Property Postal Code"
              />
              <div class="suggestion-dropdown hidden"></div>
              <p class="error error-postalCode"></p>
            </div>
            <div style="width: 100%; height: 55px; margin-top: 40px">
              <label for="property-type">Property Type</label>

              <select
                class="property-type"
                id="property-type"
                style="
                  font-size: 16px;
                  width: 100%;
                  height: 100%;
                  margin-top: 5px;
                  padding: 2px 15px;
                  border-radius: 5px;
                  border: none;
                  background-color: #d9e2ed;
                "
              >
                <option value="Property Type" disabled selected>
                  Property Type
                </option>
                <option value="HDB">HDB</option>
                <option value="Apartment/ Condominium/ Executive Condominium">
                  Apartment/ Condominium/ Executive Condominium
                </option>
                <option value="Strata Landed">Strata Landed</option>
                <option value="Landed">Landed</option>
                <option value="Walk-up Apartment">Walk-up Apartment</option>
              </select>
              <p class="error error-propertyType"></p>
            </div>
            <div style="width: 100%; height: 55px; margin-top: 40px">
              <label for="unit-number">Unit Number</label>

              <input
                class="unit-number"
                type="text"
                id="unit-number"
                style="
                  font-size: 16px;
                  width: 100%;
                  height: 100%;
                  margin-top: 5px;
                  padding: 2px 15px;
                  border-radius: 5px;
                  border: none;
                  background-color: #d9e2ed;
                "
                placeholder="Unit Number"
              />
              <p class="error error-unitNumber"></p>
            </div>
            <div style="width: 100%; height: 55px; margin-top: 40px" class="hidden bedroom-container">
              <label for="bedroom-type">Bedroom Type</label>
              <select
                class="bedroom-type"
                id="bedroom-type"
                style="
                  font-size: 16px;
                  width: 100%;
                  height: 100%;
                  padding: 2px 15px;
                  border-radius: 5px;
                  border: none;
                  background-color: #d9e2ed;
                "
              >
                <option value="Bedroom Type" disabled selected>
                  Bedrooms
                </option>
              </select>
              <p class="error error-bedroomType"></p>
            </div>
            <div style="width: 100%; height: 55px; margin-top: 40px" class="hidden foorRange-container">
              <label for="floor-range">Floor Range</label>
              <select
                class="floor-range"
                id="floor-range"
                style="
                  font-size: 16px;
                  width: 100%;
                  height: 100%;
                  padding: 2px 15px;
                  border-radius: 5px;
                  border: none;
                  background-color: #d9e2ed;
                "
              >
                <option value="Floor Range" disabled selected>
                  Floor Range
                </option>
              </select>
              <p class="error error-foorRange"></p>
            </div>
            
          </div>

          <div style="margin-top: 50px;">
            <p style="margin-top: 20px">
              The property price range provided is indicative and does not replace a formal valuation by a licensed appraiser. Actual valuations may vary depending on different methods and assumptions. This information offers a general overview of recent sales prices in your area, sourced from URA. For a more precise estimate, you will receive a 40+ page home report specific to your unit via WhatsApp, provided by our partner consultants. Our consultants are available for a free consultation, offering real estate advice, mortgage planning, or a second opinion on your propertyâ€™s value.
            </p>
          </div>

          <div style="margin-top: 20px">
            <p>Powered by CKS Property Consultants.</p>
            <div style="margin-top: 15px">
              <button
                class="get-valuation-btn"
                style="
                  width: 300px;
                  cursor: pointer;
                  height: 45px;
                  background-color: #4e6cf2;
                  border: none;
                  color: white;
                  font-size: 16px;
                  font-weight: 600;
                "
              >
                Get Valuation
              </button>
            </div>
          </div>
        </div>

        <!-- PART TWO -->
        <div class="part-two hidden">
          <div style="margin-top: 20px">
            <div style="width: 100%; height: 55px">
              <label for="name">Full Name</label>
              <input
                class="name"
                id="name"
                type="text"
                style="
                  font-size: 16px;
                  width: 100%;
                  height: 100%;
                  border-radius: 5px;
                  border: none;
                  padding: 2px 15px;
                  background-color: #d9e2ed;
                "
                placeholder="Full Name (as per NRIC or Passport)"
              />
              <p class="error error-name"></p>
            </div>
            <div style="width: 100%; height: 55px; margin-top: 40px">
              <label for="email">Email</label>
              <input
                class="email"
                id="email"
                type="text"
                style="
                  font-size: 16px;
                  width: 100%;
                  height: 100%;
                  border-radius: 5px;
                  border: none;
                  padding: 2px 15px;
                  background-color: #d9e2ed;
                "
                placeholder="Email Address"
              />
              <p class="error error-email"></p>
            </div>
            <div style="width: 100%; height: 55px; margin-top: 40px">
              <label for="phone">Mobile Number</label>
              <div
                style="
                  display: flex;
                  width: 100%;
                  height: 100%;
                  background-color: #d9e2ed;
                  border-radius: 5px;
                  padding: 2px 15px;
                "
              >
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 50px;
                    height: 100%;
                  "
                >
                  <img src="flag.png" alt="" style="width: 60px" />
                </div>
               
                <input
                  class="phone"
                  type="tel"
                  id="phone"
                  style="
                    background-color: transparent;
                    font-size: 16px;
                    width: 100%;
                    height: 100%;
                    border-radius: 5px;
                    border: none;
                    padding: 2px 15px;
                  "
                  placeholder="Mobile Number"
                />
              </div>
              <p class="error error-phone"></p>
            </div>
          </div>
          <div class="btn-container" >
            <div style="width: 50%">
              <button
                class="previous"
                style="
                  cursor: pointer;
                  width: 100%;
                  height: 45px;
                  border: none;
                  background-color: #ffffff;
                  color: #4e6cf2;
                  font-size: 15px;
                "
              >
                Previous
              </button>
            </div>
            <div style="width: 50%">
              <button
                class="submit-btn"
                style="
                  cursor: pointer;
                  width: 100%;
                  height: 45px;
                  border: none;
                  background-color: #4e6cf2;
                  color: white;
                  font-size: 15px;
                "
              >
                Get Valuation
              </button>
            </div>
          </div>
        </div>
      </div>


      <input type="text" hidden class="block">
      <input type="text" hidden class="street">
    </div>
  </body>
  <script>            
    // utilities        
    function debounce(func, delay) {
        let timeoutId;
        
        return function(...args) {
            // Clear the previous timeout
            clearTimeout(timeoutId);
            
            // Set a new timeout
            timeoutId = setTimeout(() => {
            func.apply(this, args);
            }, delay);
        };
    }
</script>
  <script>
    let searchResult = [];
    let globalIndex = -1;
    let streets = [];
 

    fillPostalFromParams();
    changeColorUsingParams();
    addEventListenerOnStart();
    fetchAllStreets()
    const partOne = document.querySelector(".part-one");
    const partTwo = document.querySelector(".part-two");
    const getValuation = document.querySelector(".get-valuation-btn");
    const previous = document.querySelector(".previous");
    const stepOneCircle = document.querySelector(".step-one-circle");
    const stepTwoCircle = document.querySelector(".step-two-circle");
    const submitBtn = document.querySelector(".submit-btn");

    getValuation.addEventListener("click", () => {
      if (!validateStepOne()) {
        return;
      }
      stepOneCircle.classList.add("bg-green");
      stepOneCircle.classList.remove("bg-white");
      partOne.classList.add("hidden");
      partTwo.classList.remove("hidden");
    });

    const phone = document.querySelector('.phone');

    phone.addEventListener("input", function () {
      let phoneNumber = this.value.replace(/\D/g, ''); // Remove all non-digit characters

      // Ensure the number starts with 9 or 8
      if (phoneNumber.length > 0 && !['9', '8'].includes(phoneNumber[0])) {
        phoneNumber = ''; // Clear the input if it doesn't start with 9 or 8
      }

      // Limit the length to 8 digits
      if (phoneNumber.length > 8) {
        phoneNumber = phoneNumber.slice(0, 8);
      }

      console.log(phoneNumber);
      this.value = phoneNumber; // Update the input field value
    });

    const name = document.querySelector('.name');

    name.addEventListener("input", function () {
      // Replace any characters that are not letters or spaces
      let nameValue = this.value.replace(/[^a-zA-Z\s]/g, '');
      
      this.value = nameValue; // Update the input field with valid characters
    });




    previous.addEventListener("click", () => {
      stepOneCircle.classList.remove("bg-green");
      stepOneCircle.classList.add("bg-white");
      partOne.classList.remove("hidden");
      partTwo.classList.add("hidden");
    });

    submitBtn.addEventListener("click", () => {
      if (!validateStepTwo()) {
        return;
      }

      const block = document.querySelector(".block").value;
      const roadName = document.querySelector(".street")?.value?.replace("STREET", "ST");
      const propertyType = document.querySelector(".property-type").value;
      const bedroomType = document.querySelector('.bedroom-type').value;
      const floorRange = document.querySelector('.floor-range').value



      const form = document.createElement("form");

      let url = "";

      if(propertyType == "HDB"){
        url = 'https://api.formautomations.homes/' + '/api/hdb/valuation/html?' + 'block=' + block + '&street_name=' + roadName + '&flat_type=' + bedroomType + '&propertyType=' + propertyType
      }else{
        url = `https://api.formautomations.homes/api/condo/valuation?street=${roadName}&floorRange=${floorRange}&propertyType=${propertyType}`
      }

      form.setAttribute('action', url)
      form.setAttribute('method', "post");
      form.setAttribute('target', "_blank");
      document.body.appendChild(form);
      form.submit();

    });

    function validateStepOne() {
      const errors = {};

      const error_paras = document.querySelectorAll(".error");
      error_paras.forEach((error_para) => (error_para.innerHTML = ""));

      const postalCode = document.querySelector(".postal-code").value;
      const propertyType = document.querySelector(".property-type").value;
      const unitNumber = document.querySelector(".unit-number").value;

      if (postalCode == "") {
        errors.postalCode = "Please enter a valid postal code";
      }


      // property type should be selected
      if (propertyType == "Property Type") {
        errors.propertyType = "Please select a property type";
      }


      if(propertyType == "HDB"){
        const bedroomType = document.querySelector(".bedroom-type").value;
        if(bedroomType == ""){
          errors.bedroomType = "Please select a bedroom type";
        }
      }else{
        const foorRange = document.querySelector(".floor-range").value;
        if(foorRange == ""){
          errors.foorRange = "Please select a floor range";
        }
      }



      // unit number should be a number
      if (unitNumber == "" || isNaN(unitNumber)) {
        errors.unitNumber = "Please enter a valid unit number";
      }

      if (Object.keys(errors).length > 0) {
        Object.keys(errors).forEach((key) => {
          document.querySelector(`.error-${key}`).innerHTML = errors[key];
        });
        return false;
      } else {
        return true;
      }
    }

    function validateStepTwo() {
      const errors = {};
      const error_paras = document.querySelectorAll(".error");
      error_paras.forEach((error_para) => (error_para.innerHTML = ""));

      const fullName = document.querySelector(".name").value;
      const email = document.querySelector(".email").value;
      const mobileNumber = document.querySelector(".phone").value;

      // full name should be at least 2 characters
      if (fullName.length < 2) {
        errors.name = "Please enter a valid full name";
      }

      // email should be a valid email
      if (!isValidEmail(email)) {
        errors.email = "Please enter a valid email";
      }

      // mobile number should be a valid mobile number
      if (!isValidMobileNumber(mobileNumber)) {
        errors.phone = "Please enter a valid mobile number";
      }

      if (Object.keys(errors).length > 0) {
        Object.keys(errors).forEach((key) => {
          document.querySelector(`.error-${key}`).innerHTML = errors[key];
        });
        return false;
      }
      return true;
    }

    function isValidEmail(email) {
      const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return regex.test(email);
    }

    function isValidMobileNumber(mobileNumber) {
      const regex = /^[0-9]{8}$/;
      return regex.test(mobileNumber);
    }



    async function fillPostalFromParams() {
        const params = new URLSearchParams(window.location.search);
        const address = params.get("address");
        const block = params.get("block");
        const roadName = params.get("ROAD_NAME");

        
        if(address){
        const addressInput = document.querySelector(".postal-code")
          addressInput.value = address;
        }

        if(block){
          document.querySelector(".block").value = block;
        }

        if(roadName){
          document.querySelector(".street").value = roadName;
        }


        await populatePropertyType(roadName); 
    }


    function addEventListenerOnStart(){
      const propertyType = document.querySelector(".property-type");
      
      propertyType.addEventListener("change", async ()=>{
        const street = document.querySelector(".street").value;
        const propertyType = document.querySelector(".property-type").value;
        const {bedrooms, floorRanges} = await fetchBedroomsOrFloorRange(street, propertyType);
        if(propertyType == "HDB"){
          // sort based on flat type
          bedrooms.sort((a, b) => a.flat_type.localeCompare(b.flat_type));
          const bedroomType = document.querySelector(".bedroom-type");
          const foorRange = document.querySelector(".floor-range");
          bedroomType.innerHTML = "";


          bedroomType.innerHTML = `
            <option value="Select Flat Type" disabled selected>Select Flat Type</option>
            ${bedrooms.map((bedroom)=>{
              return `<option value="${bedroom.flat_type}">${bedroom.flat_type}</option>`
            }).join("")}
          
          `
          bedroomType.parentElement.classList.remove("hidden");
          foorRange.parentElement.classList.add("hidden");
        }else{
          // sort based on floor range
          floorRanges.sort((a, b) => a.floorRange.localeCompare(b.floorRange));
          const bedroomType = document.querySelector(".bedroom-type");
          const foorRange = document.querySelector(".floor-range");
          bedroomType.parentElement.classList.add("hidden");
          foorRange.parentElement.classList.remove("hidden");
          foorRange.innerHTML = "";
          for (const floorRange of floorRanges) {
            const option = document.createElement("option");
            option.value = floorRange.floorRange;
            option.innerHTML = floorRange.floorRange;
            foorRange.appendChild(option);
          }
        }
      })

     






    }


    async function fetchBedroomsOrFloorRange(street, propertyType){
      const response = await fetch(`https://api.formautomations.homes/api/address?street=${street}&propertyType=${propertyType}`)
      const data = await response.json();
      return data;
    }
  

    async function fetchPropertyType(street){
      try {
        const response = await fetch(`https://api.formautomations.homes/api/propertyType?street=${street}`)
        const data = await response.json();
        return data;        
      } catch (error) {
        return {
          propertyType:[]
        };
      }
    }

  function changeColorUsingParams() {
    const params = new URLSearchParams(window.location.search);
    const color = params.get("color");
    const btnColor = params.get("btnColor");
    if (color) {
      document.body.style.backgroundColor = `#${color}`;
    }

    if(btnColor){
      document.querySelector(".get-valuation-btn").style.backgroundColor = `#${btnColor}`;
      document.querySelector(".submit-btn").style.backgroundColor = `#${btnColor}`;
      document.querySelector(".previous").style.color = `#${btnColor}`;

    }
  }



  const address = document.querySelector("#postal-code");
  const suggestionDropdown = document.querySelector(".suggestion-dropdown")
    address.addEventListener('input', debounce(async ()=>{
      const value  = address.value
      if(!value || value == ""){
          suggestionDropdown.classList.add("hidden")
          return;
      }
      
      const data = await fetchAddressSuggestion(value);
      

      suggestionDropdown.innerHTML = ""

      const filteredAdress = data.filter((item)=>{



          const isStreetExist = streets.find((street)=>{
              return street == item.ROAD_NAME.replace("STREET", "ST")
          })

          console.log(isStreetExist)


          return (
              
          !item.ADDRESS.includes("BUS STOP") && isStreetExist
      )
      })
      suggestionDropdown.classList.remove("hidden")


      if(filteredAdress.length == 0){
          suggestionDropdown.innerHTML = `<div style="padding: 12px; font-size: 14px; color: red">No results found</div>`
          return;
      }

      filteredAdress.forEach((item, index)=>{
          suggestionDropdown.innerHTML += `  
          <div data-index="${index}" onclick="handleDropdownClick(this)">
              ${item.ADDRESS}
          </div>`
      })

      searchResult = filteredAdress;
  }, 200))


  async function fetchAddressSuggestion(value){
      console.log("trigger API")
      const response = await fetch(`https://www.onemap.gov.sg/api/common/elastic/search?searchVal=${value}&returnGeom=Y&getAddrDetails=Y&pageNum=1`)
      const data = await response.json();
      return data.results;
  }

  function handleDropdownClick(element) {
      const index = element.getAttribute('data-index');
      globalIndex = parseInt(index, 10); // Convert to number
      const value = searchResult[globalIndex].ADDRESS;
      address.value = value;
      document.querySelector(".street").value = searchResult[globalIndex].ROAD_NAME;
      document.querySelector(".block").value = searchResult[globalIndex].BLK_NO;
      populatePropertyType(searchResult[globalIndex].ROAD_NAME);
      suggestionDropdown.classList.add("hidden");
  }

  async function fetchAllStreets(){
      const response = await fetch('https://api.formautomations.homes/api/streets')
      const data = await response.json();
      streets = data?.streets;
      return data;
  }


  async function populatePropertyType(street){
    const {propertyType} = await fetchPropertyType(street);
    document.querySelector(".property-type").innerHTML = `
        <option value="Select Property Type" disabled selected>Select Property Type</option>
        ${propertyType?.map((propertyType)=>{
            return `<option value="${propertyType.propertyType}">${propertyType.propertyType}</option>`
        }).join("")}
    `
  }
  
  </script>
   
</html>
